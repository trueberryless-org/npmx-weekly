---
import { BlueskyPost } from "@astro-community/astro-embed-bluesky";
import { Image } from "astro:assets";
import { marked } from "marked";

interface Source {
  platform: "github" | "bluesky" | "web" | string;
  url: string;
}

interface Props {
  title: string;
  paragraphs: string;
  sources: Source[];
}

const { title, paragraphs, sources = [] } = Astro.props;

const content = marked.parse(paragraphs);

const primarySource = sources && sources.length > 0 ? sources[0] : null;
const otherSources = sources && sources.length > 1 ? sources.slice(1) : [];

const isGitHub = (url: string) => url.includes("github.com");
const isBluesky = (url: string) => url.includes("bsky.app");

const getGitHubOg = (url: string) => {
  const parts = url.replace("https://github.com/", "").split("/");
  const [user, repo, type, id] = parts;
  return `https://opengraph.githubassets.com/1/${user}/${repo}/${type}/${id}`;
};

const getMetaOgImage = (url: string) => {
  return `https://api.microlink.io?url=${encodeURIComponent(url)}&embed=image.url`;
};

const getDisplayLabel = (source: Source) => {
  const { platform, url } = source;

  if (isGitHub(url)) {
    const parts = url.split("/");
    const id = parts.pop();
    const type = parts.pop();

    if (type === "pull") return `GitHub PR #${id}`;
    if (type === "issues") return `GitHub Issue #${id}`;
    if (type === "commit") return `Commit ${id?.substring(0, 7)}`;
    return "GitHub Resource";
  }

  if (isBluesky(url)) {
    const match = url.match(/\/profile\/([^/]+)/);
    const handle = match ? match[1] : null;
    return handle ? `Bluesky post by ${handle}` : "Bluesky Post";
  }

  if (platform === "web") {
    try {
      const { hostname } = new URL(url);
      return hostname.replace("www.", "");
    } catch {
      return "Web Link";
    }
  }

  return platform;
};
---

<section class="topic-section">
  <h3>{title}</h3>

  <div class="immersive-preview">
    {
      primarySource && isBluesky(primarySource.url) && (
        <div class="embed-container">
          <BlueskyPost id={primarySource.url} />
        </div>
      )
    }

    {
      primarySource && isGitHub(primarySource.url) && (
        <a
          href={primarySource.url}
          target="_blank"
          rel="noopener noreferrer"
          class="gh-preview"
        >
          <Image
            src={getGitHubOg(primarySource.url)}
            alt={`GitHub Preview for ${title}`}
            width={1200}
            height={600}
            format="webp"
            loading="lazy"
          />
        </a>
      )
    }

    {
      primarySource &&
        !isBluesky(primarySource.url) &&
        !isGitHub(primarySource.url) && (
          <a
            href={primarySource.url}
            target="_blank"
            rel="noopener noreferrer"
            class="web-preview"
          >
            <div class="web-preview-container">
              <img
                src={getMetaOgImage(primarySource.url)}
                alt={`Preview for ${title}`}
                loading="lazy"
                onerror="this.parentElement.style.display='none'"
              />
              <div class="web-preview-overlay">
                <span>{getDisplayLabel(primarySource)}</span>
              </div>
            </div>
          </a>
        )
    }
  </div>

  <div class="content" set:html={content} />

  {
    otherSources.length > 0 && (
      <div class="resources">
        <h4>Resources</h4>
        <ul>
          {otherSources.map((source) => (
            <li>
              <a href={source.url} target="_blank" rel="noopener noreferrer">
                {getDisplayLabel(source)}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )
  }
</section>

<style>
  .topic-section {
    margin: 4rem 0;
  }

  h3 {
    font-size: 1.6rem;
    margin-bottom: 1.5rem;
    color: var(--text);
  }

  .immersive-preview {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    padding: 2rem 0;
  }

  .gh-preview {
    display: block;
    max-width: 800px;
    width: 90%;
    transition: transform 0.2s ease;
  }

  .gh-preview:hover {
    transform: scale(1.02);
  }

  .gh-preview img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  }

  .embed-container {
    width: 100%;
    padding: 0 1rem;
  }

  .generic-source-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: bold;
  }

  .resources {
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(var(--accent-rgb), 0.05);
    border-radius: 8px;
  }

  .resources h4 {
    font-family: monospace;
    font-size: 0.8rem;
    text-transform: uppercase;
    margin-bottom: 1rem;
    color: var(--text-muted);
  }

  .resources ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.2rem 1.5rem;
  }

  .resources li {
    margin-bottom: 0;
  }

  .resources a {
    font-size: 0.9rem;
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
  }

  .resources a:hover {
    border-bottom-color: var(--accent);
  }

  .web-preview {
    display: block;
    width: 90%;
    max-width: 800px;
    text-decoration: none;
    transition: transform 0.2s ease;
  }

  .web-preview:hover {
    transform: scale(1.02);
  }

  .web-preview-container {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    background: #1a1a1a;
    aspect-ratio: 1200 / 630;
  }

  .web-preview-container img {
    width: 100%;
    height: auto;
    object-fit: contain; /* Changed to contain to ensure the full OG image is visible */
    background: #000;
  }

  .web-preview-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    color: white;
    font-size: 0.9rem;
    font-weight: bold;
  }

  @media (max-width: 800px) {
    .immersive-preview {
      padding: 1rem 0;
    }
  }
</style>
